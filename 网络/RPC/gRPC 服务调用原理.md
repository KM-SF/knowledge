# 常用的服务调用方式

无论是 RPC 框架，还是当前比较流行的微服务框架，通常都会提供多种服务调用方式，以满足不同业务场景的需求，比较常用的服务调用方式如下：

1. **同步服务调用：**最常用的服务调用方式，开发比较简单，比较符合编程人员的习惯，代码相对容易维护些；
2. **并行服务调用：**对于无上下文依赖的多个服务，可以一次并行发起多个调用，这样可以有效降低服务调用的时延；
3. **异步服务调用：**客户端发起服务调用之后，不同步等待响应，而是注册监听器或者回调函数，待接收到响应之后发起异步回调，驱动业务流程继续执行，比较常用的有 Reactive 响应式编程和 JDK 的 Future-Listener 回调机制。

# gRPC 服务调用

gRPC 的通信协议基于标准的 HTTP/2 设计，主要提供了两种 RPC 调用方式：

1. 普通 RPC 调用方式，即请求 - 响应模式。
2. 基于 HTTP/2.0 的 streaming 调用方式。

## 普通 RPC 调用

普通的 RPC 调用提供了三种实现方式：

1. 同步阻塞式服务调用，通常实现类是 xxxBlockingStub（基于 proto 定义生成）。
2. 异步非阻塞调用，基于 Future-Listener 机制，通常实现类是 xxxFutureStub。
3. 异步非阻塞调用，基于 Reactive 的响应式编程模式，通常实现类是 xxxStub。

## Streaming 模式服务调用

基于 HTTP/2.0,gRPC 提供了三种 streaming 模式：

1. 服务端 streaming
2. 客户端 streaming
3. 服务端和客户端双向 streaming

### 服务端 streaming

服务端 streaming 模式指客户端 1 个请求，服务端返回 N 个响应，每个响应可以单独的返回

适用的场景主要是客户端发送单个请求，但是服务端可能返回的是一个响应列表，服务端不想等到所有的响应列表都组装完成才返回应答给客户端，而是处理完成一个就返回一个响应，直到服务端关闭 stream，通知客户端响应全部发送完成。

在实际业务中，应用场景还是比较多的，最典型的如 SP 短信群发功能

服务端 streaming 模式的本质就是如果响应是个列表，列表中的单个响应比较独立，有些耗时长，有些耗时短，为了防止快的等慢的，可以处理完一个就返回一个，不需要等所有的都处理完才统一返回响应。可以有效避免客户端要么在等待，要么需要批量处理响应，资源使用不均的问题，也可以压缩单个响应的时延，端到端提升用户的体验（时延敏感型业务）。

像请求 - 响应 - 异步通知类业务，也比较适合使用服务端 streaming 模式

### 客户端 streaming

与服务端 streaming 类似，客户端发送多个请求，服务端返回一个响应，多用于汇聚和汇总计算场景

### 双向 streaming

客户端发送 N 个请求，服务端返回 N 个或者 M 个响应，利用该特性，可以充分利用 HTTP/2.0 的多路复用功能，在某个时刻，HTTP/2.0 链路上可以既有请求也有响应，实现了全双工通信（对比单行道和双向车道）

对于双向 Streaming 模式，只支持异步调用方式。

## 总结

gRPC 服务调用支持同步和异步方式，同时也支持普通的 RPC 和 streaming 模式，可以最大程度满足业务的需求。
对于 streaming 模式，可以充分利用 HTTP/2.0 协议的多路复用功能，实现在一条 HTTP 链路上并行双向传输数据，有效的解决了 HTTP/1.X 的数据单向传输问题，在大幅减少 HTTP 连接的情况下，充分利用单条链路的性能，可以媲美传统的 RPC 私有长连接协议：更少的链路、更高的性能：
